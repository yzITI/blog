---
title: 凝水成冰——记学生事务系统的结构化
date: 2020-2-11 10:24:55
categories:
- 开发之路
tags:
- Golang
- 架构
toc: true
---

结构决定性质，也创造美。  ——纪念一次合作开发

> 散落的逻辑在精巧的架构下结合为美丽的代码，这就好像水分子因为氢键形成稳定而美丽的冰晶一样，细微而又宏大。

<!-- more -->

## 前言

从化学课抄来一句很著名、私底下也觉得很妙的话：

> Die Entropie der Welt strebt einem Maximum zu. (1865, Rudolph J. E. Clausius)

这是整个世界的规律，就好像房间总是会慢慢变乱，代码总是会越写越烦一样。

说到学生事务系统，其实很多年前就有这方面的想法。某次学校拓展性课程出现(31/30)的bug的时候就很想重做一个，后来体育选课因为流量太大爆炸，更加坚定了这个想法，只是一直觉得没有能力和精力去实现它，因为应用有些庞大，需求有点复杂。

后来有了团队成员的帮助，就觉得轻松一些，有一战之力，于是就勇敢的迎战了。

能够十分有条理的完成这样一个有些复杂的工程，是一个团队的努力和成就。在这里特别感谢学校的大力支持，特别是学校给学生提供这样一个难能可贵机会，同时也感谢参与项目开发和对项目有贡献的大佬们：
- CmdBlock
- Phantomlsh
- Tina
- Queenie

弱弱加一句，本文作者是Phantomlsh，废话多预警。

## 最初的目标

故事开始于一个很小很小的办公室，烟雾缭绕、风扇狂转、指示灯频繁闪烁、键盘噼里啪啦响作一团，其间有两个人低语密谋着些什么......

打住打住！只不过是两个学生在商量一个小应用而已：让学生自己上传照片制作校园卡。

以往总是学校组织学生排队拍照片，不仅很麻烦，而且大家拍出来的头像照片也是千篇一律，因此信息组希望能够有一个网页可以让学生自己上传照片。没问题！小事！第二天我就和CmdBlock大佬面对面飞速构建了一个简单的应用：后端```Golang + Mongodb```，前端```Vuejs```加一堆奇奇怪怪的插件（其实登录部分之类的也拿了一些以前做过的项目的代码）。用户登录以后可以选择照片、剪裁然后上传。服务器根据用户保存照片文件，通过控制前端剪裁框的大小来让最后保存的照片尺寸统一。

这也许就是学生事务系统的雏形啦，一切都很简单，也没怎么考虑什么安全性和结构化，毕竟只是实现一个小小的功能嘛！没想到还没投入使用，就发现还需要做管理端。也就是说，老师登录以后可以查看并审核一个班所有人的照片。其实也不是什么很大的问题，一顿乱敲以后加了一个管理页面给老师查看照片。

当时觉得这个应用真是太好玩了（它后来确实也胜任了新一届学生的照片收集任务），我和CmdBlock两个人自娱自乐了好久。只不过没人想得到，这个为了收集照片而生的小玩意，最后引出了一个巨大的工程。

> **技术细节**：
> - **后端**：Gin框架搭建http服务器，提供Restful API服务。
> - **登录**：借鉴了以前做认证系统的经验，采取两次认证的方式处理用户登录请求（首次请求发送用户名，服务端返回随机字符串；第二次请求发送用户密码密码和随机字符串的散列摘要），避免明文传输用户密码。同时在前端检查了身份证号的合法性，防止用户因为输错身份证号而白白发送登录请求，减少服务器负荷。
> - **前端页面**：因为没有CDN（哭），考虑用户加载页面的时候的服务器流量问题，前端页面不使用单页应用，同时尽量使用公用CDN上的js库。

## 地平线上的曙光

上一节的故事还是暑假的事情。那会儿我和CmdBlock两人天天在小办公室里面~~玩耍~~学习，根本闲不下来。所以事实上，照片上传应用不仅还没等到正式启用，甚至连名字都没想好的时候，就开始变得更加复杂。

其实想法很简单：既然做了照片上传服务，不如把学生会用到的别的服务也一起做了。CmdBlock和我一番合计，觉得当务之急就是更新学校的选课系统。具体来说，学校选课有三大问题：
1. 人数限制容易挂，30个名额的课报了31个人。
2. 并发堪忧，每次选课要么服务器爆炸重启好几次，要么就非常非常慢速。
3. 页面太丑，不太支持移动端。

第三点先不谈，这一点大多靠Tina和Queenie，我和CmdBlock也不是很擅长前端网页设计这些东西。就前两点，其实是很难解决的一个矛盾：锁的本质是限制并发，让数据库读写单线程进行，使得学生们的请求“排队”处理，这样解决两个请求同时挤进去的问题；然而如果把数据库读写变成单线程的，并发情况可就糟糕了。（这个问题其实是因为当时我们太菜了，不了解也不熟悉Redis）

CmdBlock和我一起想了很久，最后做出了一个很大胆的决定。我们把每门课的剩余人数在选课开始之前读进内存作为全局变量，就能在程序的处理队列上处理人数限制了（if语句直接解决，说白了干了跟Redis差不多的事情）！为了能够持久化，定时和```Mongodb```同步一下。问题其实是很严重的，一旦服务端崩溃，选课就必须整个重来，因为内存中的剩余人数数据就会丢失。

管他呢！反正好用就行！这里只能庆幸选课那天服务端没炸了。我私底下也觉得这点并发数应该不可能把```Golang```这种高级的协程并发搞炸，但总是心里打鼓。

再次感激学校教务处和信息组，竟然真的批准了这个新的选课系统应用在新一届学生的拓展性课程选课上。那天云淡风轻、秋高气爽（雾），我和CmdBlock两个人紧张地在办公室里面盯着大屏上的服务器监控和笔记本上的服务端运行状态，大概也只有我们知道这套系统是多么脆弱和混乱了。

很遗憾，还没正式开始，就出了bug。bug出在时间上：前端页面用js获取电脑本地时间做前端时间限制。本来后端还是有时间限制的，可是运行服务端的服务器时钟快了好几分钟！！！导致时间还没到，就有些本地时间也快了的同学卡进了选课界面并且提前选完了，在此对其他同学表示歉意！

然后呢？然后当然是一切正常啦！看着服务端刷刷的日志和流畅的运行情况，我和CmdBlock都觉得非常激动。偶尔还有一两个小同学跑到办公室来特殊处理（忘了身份证号），也有一个机房的Chrome浏览器版本太旧不支持js里面的```async/await```导致无法登录，但是总体来说，一切都很完美，达到了理想中的高并发效果！只记得当时服务端没有任何一刻是在卡顿的，好多同学姗姗来迟，发现今年一点都不卡课程瞬间抢完。

从我们加入选课服务以后，这个小小的应用才正式改名为“学生事务系统”，并且走上了它蓬勃发展的道路。

> **技术细节**：
> - **选课**：选课数据读入内存以便快速处理，充分利用```Golang```高并发的特点。
> - **模块化**：不同的服务控制器分开编写，开始体现模块化的设计思路。

## 在终点启航

选课和照片上传任务成功完成，但我们也看到了其中的若干问题：
1. 选课数据缓存在内存中不稳定，也不能使用负载均衡
2. 代码写到这一步开始后出现了一定程度的混乱，不利于后续的功能添加
3. 对于不同的选课需求，灵活性不够
4. 没有管理端

也不是很明白为什么，也许是因为看了Jenkins一类的持续集成工具，我和CmdBlock同时产生了一个想法：或许我们应该把学生事务系统做成基于任务的结构。也就是说，管理员可以发布一个任务，设置它的模板（以选课为例），填写对应的数据（有哪些课，名额有多少），选择参加的学生（某个年级），然后学生们完成他们对应的任务就可以了。

作为一个学生事务系统，这样的设计才能够满足复杂的事务需求，例如同时开展体育选课和校本课程选课。然而这样的设计有巨大的实现难度，究竟如何才能让不同的任务和它们不同的逻辑，运行在同一个程序框架之下呢？特别是，后端还是```Golang```这样的强类型编译语言。

当时已经快到我大学开学的时候了，所以我只是提出了这样一个想法，剩下来的事情都丢给了CmdBlock。他确实给出了一个极其精妙的设计，写本文的时候我又问了一下他，摘录如下：

---
**CmdBlock:** （以下为引用）

首先想到的是每次请求的时候刷新用户token的机制（增加安全性），token得找个地方存，考虑到可能的负载均衡，不能直接使用后端程序内存。然而存储数据库又慢又蠢，于是找到了高性能的内存数据库```Redis```。在尝试的过程中发现它不仅快，而且满足操作的单线程。

事务系统的目标是通用化，最好是日程安排那样，按照时间轴的那种模式。一开始对于任务设计了这样的流程：
1. 创建并指定需要的信息（例如课程目录等）
2. 指定开始和结束时间，在有效时间内接受用户的提交
3. 结束后管理员导出数据并销毁任务

后来考虑到任务的复用（同一种选课对同一批人进行多次，并且不能选以前选过的课程），就添加了开启和关闭的概念（晚自习的突发奇想）：
1. 创建任务
2. 录入信息
3. 指定开始时间并且开启任务
4. 到达开始时间，接受用户提交
5. 到达结束时间，停止接受用户提交
6. 导出结果并关闭任务
7. 回到2，或者销毁的

这样同一个任务的数据可以多次使用（和修改），任务逻辑也可以读取用户以往的提交记录。

实现不同任务对应不同的程序逻辑，目标是模块化。加一个文件就是一个模块，用了匿名函数的写法，用路由传入任务类型来运行不同的模块。

对于选课来说，发现选课数据可以放在```Redis```里面，用```lua```脚本去操作。所以任务在开启的时候可以把```Mongodb```里面的数据复制进```Redis```，实现单线程操作和高并发，同时支持负载均衡。

---

以上就是CmdBlock的设计，不得不感叹一句：  
~~晚自习真的是太闲了！~~ CmdBlock太强了！

当时我沉迷于学业，CmdBlock也开学了，整个项目就进展的很慢。所幸也没什么急迫的需求，CmdBlock就悠哉游哉地写，悠哉游哉地开启了一段新的航程。

> **技术细节**：
> - **缓存**：缓存数据使用```Redis```，支持负载均衡的同时保证高并发和操作的单线程性。
> - **用户凭证**：用户凭证每次请求都会刷新，通过请求的header传递，前端页面通过编写axios的intercept实现自动保存header到网页的sessionStorage，以及在发送前读取并设置header。
> - **后端验证**：主要使用中间件进行校验，避免控制器反复读取来自数据库的数据。
> - **服务器时间**：使用ntp自动校正服务器时间。
> - **前端页面**：开始采取双前端设计，学生使用的高并发前端页面分开加载（与之前一样），管理员使用的管理端使用```Vuecli```编写单页应用。

## 果断的蜕变

（元旦：重构&权限树）

## 全面并发！

（双前端与后端调优）

## 后记

（随便写写）