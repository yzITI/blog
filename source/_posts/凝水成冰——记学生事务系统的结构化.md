---
title: 凝水成冰——记学生事务系统的结构化
date: 2020-2-11 10:24:55
categories:
- 开发之路
tags:
- Golang
- 架构
toc: true
---

结构决定性质，也创造美。  ——纪念一次合作开发

> 散落的逻辑在精巧的架构下结合为美丽的代码，这就好像水分子因为氢键形成稳定而美丽的冰晶一样，细微而又宏大。

<!-- more -->

## 前言

从化学课抄来一句很著名、私底下也觉得很妙的话：

> Die Entropie der Welt strebt einem Maximum zu. (1865, Rudolph J. E. Clausius)

这是整个世界的规律，就好像房间总是会慢慢变乱，代码总是会越写越烦一样。

说到学生事务系统，其实很多年前就有这方面的想法。某次学校拓展性课程出现(31/30)的bug的时候就很想重做一个，后来体育选课因为流量太大爆炸，更加坚定了这个想法，只是一直觉得没有能力和精力去实现它，因为应用有些庞大，需求有点复杂。

后来有了团队成员的帮助，就觉得轻松一些，有一战之力，于是就勇敢的迎战了。

能够十分有条理的完成这样一个有些复杂的工程，是一个团队的努力和成就。在这里特别感谢学校的大力支持，特别是学校给学生提供这样一个难能可贵机会，同时也感谢参与项目开发和对项目有贡献的大佬们：
- CmdBlock
- Phantomlsh
- Tina
- Queenie

弱弱加一句，本文作者是Phantomlsh，废话多预警。

## 最初的目标

故事开始于一个很小很小的办公室，烟雾缭绕、风扇狂转、指示灯频繁闪烁、键盘噼里啪啦响作一团，其间有两个人低语密谋着些什么......

打住打住！只不过是两个学生在商量一个小应用而已：让学生自己上传照片制作校园卡。

以往总是学校组织学生排队拍照片，不仅很麻烦，而且大家拍出来的头像照片也是千篇一律，因此信息组希望能够有一个网页可以让学生自己上传照片。没问题！小事！第二天我就和CmdBlock大佬面对面飞速构建了一个简单的应用：后端```Golang + Mongodb```，前端```Vuejs```加一堆奇奇怪怪的插件（其实登录部分之类的也拿了一些以前做过的项目的代码）。用户登录以后可以选择照片、剪裁然后上传。服务器根据用户保存照片文件，通过控制前端剪裁框的大小来让最后保存的照片尺寸统一。

这也许就是学生事务系统的雏形啦，一切都很简单，也没怎么考虑什么安全性和结构化，毕竟只是实现一个小小的功能嘛！没想到还没投入使用，就发现还需要做管理端。也就是说，老师登录以后可以查看并审核一个班所有人的照片。其实也不是什么很大的问题，一顿乱敲以后加了一个管理页面给老师查看照片。

当时觉得这个应用真是太好玩了（它后来确实也胜任了新一届学生的照片收集任务），我和CmdBlock两个人自娱自乐了好久。只不过没人想得到，这个为了收集照片而生的小玩意，最后引出了一个巨大的工程。

> **技术细节**：
> - **后端**：Gin框架搭建http服务器，提供Restful API服务。
> - **登录**：借鉴了以前做认证系统的经验，采取两次认证的方式处理用户登录请求（首次请求发送用户名，服务端返回随机字符串；第二次请求发送用户密码密码和随机字符串的散列摘要），避免明文传输用户密码。
> - **前端页面**：因为没有CDN（哭），考虑用户加载页面的时候的服务器流量问题，前端页面不使用单页应用，同时尽量使用公用CDN上的js库。

## 地平线上的曙光

上一节的故事还是暑假的事情。那会儿我和CmdBlock两人天天在小办公室里面玩耍（划掉）学习，根本闲不下来。所以事实上，照片上传应用不仅还没等到正式启用，甚至连名字都没想好的时候，就开始变得更加复杂。

其实想法很简单：既然做了照片上传服务，不如把学生会用到的别的服务也一起做了。CmdBlock和我一番合计，觉得当务之急就是更新学校的选课系统。具体来说，学校选课有三大问题：
1. 人数限制容易挂，30个名额的课报了31个人。
2. 并发堪忧，每次选课要么服务器爆炸重启好几次，要么就非常非常慢速。
3. 页面太丑，不太支持移动端。

第三点先不谈，这一点大多靠Tina和Queenie，我和CmdBlock也不是很擅长前端网页设计这些东西。就前两点，其实是很难解决的一个矛盾：锁的本质是限制并发，让数据库读写单线程进行，使得学生们的请求“排队”处理，这样解决两个请求同时挤进去的问题；然而如果把数据库读写变成单线程的，并发情况可就糟糕了。（这个问题其实是因为当时我们太菜了，不了解也不熟悉Redis）

CmdBlock和我一起想了很久，最后做出了一个很大胆的想法。我们把每门课的剩余人数在选课开始之前读进内存作为全局变量，就能在程序的处理队列上处理人数限制了（if语句直接解决，说白了干了跟Redis差不多的事情）！为了能够持久化，定时和```Mongodb```同步一下。问题其实是很严重的，一旦服务端崩溃，选课就必须整个重来，因为内存中的剩余人数数据就会丢失。

管他呢！反正好用就行！这里只能庆幸选课那天服务端没炸了。我私底下觉得这点并发数应该不可能把```Golang```这种高级的协程并发搞炸。

再次感激学校教务处和信息组，竟然真的批准了这个新的选课系统应用在新一届学生的拓展性课程选课上。那天云淡风轻、秋高气爽（雾），我和CmdBlock两个人紧张地在办公室里面盯着大屏上的服务器监控和笔记本上的服务端运行状态，大概也只有我们知道这套系统是多么脆弱和不稳定了。（未完）

## 在终点启航

（新版，任务化模块化）

## 果断的蜕变

（元旦：重构&权限树）

## 全面并发！

（双前端与后端调优）

## 后记

（随便写写）